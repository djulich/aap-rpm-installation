# libvirt kickstart file for automated installation of RHEL for AAP nodes.
#
# This file usually lives in /var/lib/libvirt/images/aap_ks.cfg
#
# sudo virt-install \
#   --name aap-gateway \
#   --description 'AAP Gateway on RHEL 9.6' \
#   --ram 8192 \
#   --vcpus 2 \
#   --disk /var/lib/libvirt/images/aap-gateway.qcow2,size=50,bus=virtio \
#   --os-variant rhel9.5 \
#   --network bridge=br0,model=virtio \
#   --graphics none \
#   --location /var/lib/libvirt/images/rhel-9.6-x86_64-dvd.iso \
#   --initrd-inject=/var/lib/libvirt/images/aap_ks.cfg \
#   --extra-args="inst.ks=file:/aap_ks.cfg console=ttyS0 inst.text inst.hostname=aap-gateway"

#version=RHEL9
text
cmdline
reboot
firstboot --disable

# ---- Locale & time ----
lang en_US.UTF-8
keyboard de
timezone Europe/Berlin --utc
# timezone Europe/Berlin --utc --ntpservers=pool.ntp.org

# ---- Networking ----
# Use DHCP on first NIC and bring it up
network --bootproto=dhcp --device=link --activate

# ---- RHSM / subscription ----
# Registers during install using your activation key (get from https://access.redhat.com/downloads/content/rhel) + org id (11009103)
rhsm --activation-key=e6760df0-58ca-4d28-8daf-a952a138c74c --organization=11009103

# ---- Users & auth ----
# EDIT ME: replace the password hashes below (generate with:  openssl passwd -6 'yourpassword')
# The root and ansible password is 'ansible'. sha512 created with "$ openssl passwd -6 ansible".
rootpw --iscrypted  $6$.Ovvow/I9ulqqz8r$5H2gPJ7Pntf/Zwqze.q/IPhaiNwqt.O71YNAXAxLsS/999zavLaGeywFkbHqq62g61cmCPS1Um7FxffS9slsU.
user --name=ansible --groups=wheel --iscrypted --password=$6$.Ovvow/I9ulqqz8r$5H2gPJ7Pntf/Zwqze.q/IPhaiNwqt.O71YNAXAxLsS/999zavLaGeywFkbHqq62g61cmCPS1Um7FxffS9slsU.
# The public key from the host. This enables ssh from host into the VM. Needed if setup.sh is run on the host.
sshkey --username=ansible "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJzyZHT6ju+ml6hn6qvACCM1lXU5SR75OYznRxthZXwj djulich@djulich-thinkpadp16vgen1.rmtde.csb"
# The public key from the automationcontroller. This enables ssh from the controller to gateway, db, etc (needed if setup.sh is executed on the controller VM).
sshkey --username=ansible "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDwjzN7iteKmyIvXkaJ+7D3X/IdOawR3x/1MZvQQRrui ansible@aap-controller"

authselect --enableshadow --passalgo=sha512

# ---- Security & services ----
selinux --enforcing
firewall --enabled --service=ssh
services --enabled=sshd,chronyd,firewalld

# ---- Storage (virtio disk vda by default) ----
ignoredisk --only-use=vda
bootloader --timeout=1
clearpart --all --initlabel --drives=vda
autopart --type=lvm

# ---- Packages ----
%packages
@^minimal-environment
# Ensure SSH server & clients are present
openssh-server
openssh-clients
# ansible-core from RHEL 9 AppStream (enabled via RHSM registration)
ansible-core
# handy tools
kexec-tools
python3
vim
%end

# ---- Post-install configuration ----
%post --log=/root/ks-post.log --erroronfail

# Make sure wheel can sudo without a password (optional)
echo "%wheel ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/99-wheel-nopasswd
chmod 440 /etc/sudoers.d/99-wheel-nopasswd

# Ensure SSH daemon is enabled and configured sanely
systemctl enable sshd
mkdir -p /home/ansible/.ssh
chmod 700 /home/ansible/.ssh
chown -R ansible:ansible /home/ansible/.ssh

# Generate an ed25519 keypair for the 'ansible' user (no passphrase)
runuser -l ansible -c 'ssh-keygen -t ed25519 -q -N "" -f ~/.ssh/id_ed25519'

# Add its own public key to authorized_keys (optional)
runuser -l ansible -c 'cat ~/.ssh/id_ed25519.pub >> ~/.ssh/authorized_keys && chmod 600 ~/.ssh/authorized_keys'

# (Optional) Keep a copy of the public key somewhere root can read easily
cp /home/ansible/.ssh/id_ed25519.pub /root/ansible_id_ed25519.pub
chmod 644 /root/ansible_id_ed25519.pub

# Optionally make sure PasswordAuthentication stays enabled (or set to 'no' if you prefer strictly keys)
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
sed -i 's/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
# sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
systemctl restart sshd

# (Optional) Update to latest packages
# subscription-manager refresh || true
# dnf -y update
# command -v needs-restarting >/dev/null 2>&1 || dnf -y install dnf-plugins-core
# needs-restarting -r || echo "Reboot recommended to use updated kernel" >> /root/ks-post.log

# Confirm RHSM status in the log
subscription-manager status || true
subscription-manager list --consumed || true

# Fix SELinux labels last
restorecon -R /home/ansible/.ssh

%end

